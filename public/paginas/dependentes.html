<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital+ | Selecionar Dependente</title>
    <link rel="stylesheet" href="../styles/dependentes.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
     <link rel="icon" href="../assets/logo minimalista.png">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>

<body>
    <div class="dependentes-container">
        <div class="dependentes-header">
            <img src="../assets/logo3.png" alt="Vital+ Logo" class="logo-img" style="height: 100px; width: auto;">
            <h1>Selecionar Dependente</h1>
            <p>Escolha o dependente que deseja acompanhar</p>
        </div>

        <div class="dependentes-grid" id="dependentesGrid">
            <!-- Cards ser√£o carregados dinamicamente via JavaScript -->

            <div class="dependente-card" data-id="add">
                <div class="dependente-avatar">
                    <div class="avatar-placeholder">
                        <i data-feather="plus"></i>
                    </div>
                </div>
                <div class="dependente-info">
                    <h3>Adicionar Dependente</h3>
                    <p>Adicione um novo dependente para acompanhar</p>
                </div>
                <button class="btn-adicionar">Adicionar</button>
            </div>
        </div>

        <div class="dependentes-footer">
            <a href="#" class="logout-link">Sair</a>
        </div>
    </div>

    <script>
        // dependentes.js - VERS√ÉO CORRIGIDA

        document.addEventListener("DOMContentLoaded", function () {
            feather.replace();

            // Mostrar usu√°rio logado
            const usuarioNome = localStorage.getItem("usuarioNome");
            if (usuarioNome) {
                const header = document.querySelector(".dependentes-header h1");
                if (header) {
                    header.textContent = `Ol√°, ${usuarioNome} - Selecionar Dependente`;
                }
            }

            // Carregar dependentes do usu√°rio
            carregarDependentes();

            // ‚úÖ CORRE√á√ÉO: Atualizar a parte do redirecionamento com salvamento correto
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("btn-selecionar")) {
                    const card = e.target.closest(".dependente-card");
                    const dependenteId = card.getAttribute("data-id");
                    const dependenteNome = card.querySelector("h3").textContent;

                    // Buscar a foto do card
                    const avatarImg = card.querySelector('.dependente-avatar img');
                    const dependenteFoto = avatarImg ? avatarImg.src : '';

                    // ‚úÖ CORRE√á√ÉO: Salvar em TODOS os formatos para compatibilidade
                    localStorage.setItem("pacienteSelecionadoId", dependenteId); // ‚úÖ Nova chave
                    localStorage.setItem("dependenteSelecionado", JSON.stringify({
                        id: dependenteId,
                        nome: dependenteNome,
                        foto: dependenteFoto
                    }));

                    console.log("‚úÖ Dependente selecionado e salvo:", { 
                        id: dependenteId, 
                        nome: dependenteNome,
                        chaves_salvas: ["pacienteSelecionadoId", "dependenteSelecionado"]
                    });

                    // CORRE√á√ÉO: Redirecionar para dashboards espec√≠ficos
                    const tipoUsuario = localStorage.getItem("usuarioTipo");
                    console.log("üéØ Tipo de usu√°rio:", tipoUsuario);

                    if (tipoUsuario === "familiar_cuidador") {
                        // FAMILIAR CUIDADOR vai para DASHBOARD_FAMILIAR_CUIDADOR (novo)
                        window.location.href = "/dashboard_familiar_cuidador";
                    } else if (tipoUsuario === "familiar_contratante") {
                        // FAMILIAR CONTRATANTE vai para DASHBOARD_SUPERVISOR (existente)
                        window.location.href = "/dashboard_supervisor";
                    } else if (tipoUsuario === "cuidador_profissional") {
                        // CUIDADOR PROFISSIONAL vai para DASHBOARD_CUIDADOR
                        window.location.href = "/dashboard_cuidador";
                    } else {
                        window.location.href = "/index.html";
                    }
                }
            });

            // Adicionar novo dependente
            const btnAdicionar = document.querySelector(".btn-adicionar");
            if (btnAdicionar) {
                btnAdicionar.addEventListener("click", function () {
                    window.location.href = "cadastroPaciente.html";
                });
            }

            // Logout
            const logoutLink = document.querySelector(".logout-link");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();
                    localStorage.removeItem("dependenteSelecionado");
                    localStorage.removeItem("pacienteSelecionadoId"); // ‚úÖ Nova linha
                    localStorage.removeItem("usuarioNome");
                    localStorage.removeItem("usuarioId");
                    localStorage.removeItem("usuarioTipo");
                    window.location.href = "/";
                });
            }
        });

        // Modificar a fun√ß√£o carregarDependentes para familiar cuidador
        async function carregarDependentes() {
            const usuarioId = localStorage.getItem("usuarioId");
            const tipoUsuario = localStorage.getItem("usuarioTipo");

            console.log("üë§ Usu√°rio ID:", usuarioId, "Tipo:", tipoUsuario);

            if (!usuarioId || !tipoUsuario) {
                console.log("‚ùå Usu√°rio n√£o logado ou tipo n√£o definido - usando dados exemplo");
                usarDadosExemplo();
                return;
            }

            try {
                let pacientes = [];

                if (tipoUsuario === "familiar_cuidador") {
                    // CORRE√á√ÉO: Usar a rota espec√≠fica para familiar cuidador
                    const response = await fetch(`http://localhost:3000/api/familiares-cuidadores/${usuarioId}/pacientes`);
                    if (response.ok) {
                        pacientes = await response.json();
                        console.log("‚úÖ Pacientes do familiar cuidador:", pacientes);
                    } else {
                        console.error("‚ùå Erro ao carregar pacientes do familiar cuidador:", response.status);
                        // Tentar rota alternativa
                        const responseAlt = await fetch(`http://localhost:3000/api/familiares/${usuarioId}/pacientes_cuidador`);
                        if (responseAlt.ok) {
                            pacientes = await responseAlt.json();
                        }
                    }
                } else if (tipoUsuario === "familiar_contratante") {
                    const response = await fetch(`http://localhost:3000/api/familiares/${usuarioId}/pacientes_contratante`);
                    if (response.ok) {
                        pacientes = await response.json();
                    }
                } else if (tipoUsuario === "cuidador_profissional") {
                    pacientes = await carregarPacientesCuidador(usuarioId);
                } else {
                    console.error("‚ùå Tipo de usu√°rio desconhecido:", tipoUsuario);
                    usarDadosExemplo();
                    return;
                }

                console.log("üìã Pacientes carregados:", pacientes);
                exibirDependentes(pacientes);

            } catch (error) {
                console.error("‚ùå Erro ao carregar dependentes:", error);
                usarDadosExemplo();
            }
        }

        // Fun√ß√£o auxiliar para carregar pacientes do cuidador profissional
        async function carregarPacientesCuidador(usuarioId) {
            try {
                const response = await fetch(`http://localhost:3000/api/cuidadores/${usuarioId}/pacientes`);
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error("‚ùå Erro ao carregar pacientes do cuidador:", response.status);
                    return [];
                }
            } catch (error) {
                console.error("‚ùå Erro na requisi√ß√£o do cuidador:", error);
                return [];
            }
        }

        function exibirDependentes(pacientes) {
            const grid = document.getElementById("dependentesGrid");
            if (!grid) {
                console.error("‚ùå Elemento dependentesGrid n√£o encontrado");
                return;
            }

            // Limpar cards existentes (exceto o de adicionar)
            const cardsExistentes = grid.querySelectorAll(".dependente-card:not([data-id='add'])");
            cardsExistentes.forEach(card => card.remove());

            if (!pacientes || pacientes.length === 0) {
                grid.insertAdjacentHTML('afterbegin', `
                    <div class="dependente-card empty-state">
                        <div class="dependente-avatar">
                            <div class="avatar-placeholder">
                                <i data-feather="users"></i>
                            </div>
                        </div>
                        <div class="dependente-info">
                            <h3>Nenhum dependente</h3>
                            <p>Adicione seu primeiro dependente para come√ßar</p>
                        </div>
                    </div>
                `);
                feather.replace();
                return;
            }

            // Adicionar cards dos pacientes
            pacientes.forEach(paciente => {
                const card = criarCardDependente(paciente);
                const addCard = grid.querySelector(".dependente-card[data-id='add']");
                if (addCard) {
                    grid.insertBefore(card, addCard);
                } else {
                    grid.appendChild(card);
                }
            });

            feather.replace();
        }

        function criarCardDependente(paciente) {
            const card = document.createElement("div");
            card.className = "dependente-card";
            card.setAttribute("data-id", paciente.id || paciente.paciente_id || Date.now());

            const idade = calcularIdade(paciente.data_nascimento);
            const condicao = paciente.condicao_principal || paciente.doenca_principal || "Sem condi√ß√£o espec√≠fica";
            const fotoUrl = obterFotoDependente(paciente);

            console.log(`üé¥ Criando card para ${paciente.nome}:`, {
                fotoUrl,
                foto_perfil: paciente.foto_perfil,
                id: paciente.id
            });

            card.innerHTML = `
                <div class="dependente-avatar">
                    ${fotoUrl ?
                        `<img src="${fotoUrl}" alt="${paciente.nome}" onerror="handleImageError(this)" />` :
                        ''
                    }
                    <div class="avatar-placeholder" style="${fotoUrl ? 'display: none;' : 'display: flex;'}">
                        <i data-feather="user"></i>
                    </div>
                </div>
                <div class="dependente-info">
                    <h3>${paciente.nome || 'Nome n√£o informado'}</h3>
                    <p>${idade} anos ‚Ä¢ ${condicao}</p>
                    <div class="dependente-status">
                        <span class="status-badge status-estavel">Est√°vel</span>
                    </div>
                </div>
                <button class="btn-selecionar">Selecionar</button>
            `;

            return card;
        }

        function obterFotoDependente(paciente) {
            console.log("üñºÔ∏è Buscando foto para paciente:", paciente.nome, paciente);

            // Se tiver foto_perfil no banco de dados
            if (paciente.foto_perfil) {
                console.log("‚úÖ Foto encontrada no campo foto_perfil:", paciente.foto_perfil);

                // Construir URL completa para a foto
                let fotoUrl = `/uploads/${paciente.foto_perfil}`;
                console.log("üì∏ URL da foto:", fotoUrl);
                return fotoUrl;
            }

            // Tentar outros campos poss√≠veis
            const possiveisCampos = ['foto_url', 'foto', 'avatar', 'imagem', 'fotoUrl', 'avatar_url', 'profile_picture', 'photo_url']; 

            for (const campo of possiveisCampos) {
                if (paciente[campo]) {
                    console.log(`‚úÖ Foto encontrada no campo ${campo}:`, paciente[campo]);

                    let fotoUrl = paciente[campo];

                    // Se for um caminho relativo, garantir que tenha a barra inicial
                    if (fotoUrl && !fotoUrl.startsWith('http') && !fotoUrl.startsWith('/')) {
                        fotoUrl = '/' + fotoUrl;
                    }

                    return fotoUrl;
                }
            }

            // Verificar se h√° foto no localStorage
            const dependenteId = paciente.id || paciente.paciente_id;
            if (dependenteId) {
                const fotoStorage = localStorage.getItem(`foto_dependente_${dependenteId}`);
                if (fotoStorage) {
                    console.log("‚úÖ Foto encontrada no localStorage:", fotoStorage);
                    return fotoStorage;
                }
            }

            console.log("‚ùå Nenhuma foto encontrada para o paciente");
            return null;
        }

        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return "N/A";

            try {
                const hoje = new Date();
                const nascimento = new Date(dataNascimento);

                // Verificar se a data √© v√°lida
                if (isNaN(nascimento.getTime())) {
                    return "N/A";
                }

                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const mes = hoje.getMonth() - nascimento.getMonth();

                if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }

                return idade;
            } catch (error) {
                console.error("‚ùå Erro ao calcular idade:", error);
                return "N/A";
            }
        }

        // Fun√ß√£o para usar dados de exemplo se a API n√£o estiver dispon√≠vel
        function usarDadosExemplo() {
            console.log("üîÑ Usando dados de exemplo");
            const pacientesExemplo = [
                {
                    id: 1,
                    nome: "Maria Oliveira",
                    data_nascimento: "1945-03-15",
                    condicao_principal: "Diabetes Tipo 2",
                    foto_perfil: "velha.png"
                },
                {
                    id: 2,
                    nome: "Jo√£o Silva",
                    data_nascimento: "1951-08-22",
                    condicao_principal: "Hipertens√£o",
                    foto_perfil: "idosos.png"
                }
            ];
            exibirDependentes(pacientesExemplo);
        }

        // Fun√ß√£o global para tratamento de erro de imagem
        function handleImageError(imgElement) {
            console.log("‚ùå Erro ao carregar imagem:", imgElement.src);
            imgElement.style.display = 'none';
            const placeholder = imgElement.nextElementSibling;
            if (placeholder && placeholder.classList.contains('avatar-placeholder')) {
                placeholder.style.display = 'flex';
            }
        }

        // Fun√ß√£o para debug - verificar localStorage
        function verificarLocalStorage() {
            console.log("=== LOCAL STORAGE ===");
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(key + ":", localStorage.getItem(key));
            }
            console.log("======================");
        }
        
        // Fun√ß√£o para debug - verificar se as rotas est√£o funcionando
        async function testarRotasFamiliarCuidador() {
            const usuarioId = localStorage.getItem("usuarioId");
            const tipoUsuario = localStorage.getItem("usuarioTipo");
            
            if (tipoUsuario === "familiar_cuidador") {
                console.log("=== TESTANDO ROTAS FAMILIAR CUIDADOR ===");
                
                // Testar rota nova
                try {
                    const response = await fetch(`http://localhost:3000/api/familiares-cuidadores/${usuarioId}/pacientes`);
                    console.log("Rota nova - Status:", response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log("Rota nova - Dados:", data);
                    }
                } catch (error) {
                    console.log("Rota nova - Erro:", error.message);
                }
                
                // Testar rota antiga
                try {
                    const response = await fetch(`http://localhost:3000/api/familiares/${usuarioId}/pacientes_cuidador`);
                    console.log("Rota antiga - Status:", response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log("Rota antiga - Dados:", data);
                    }
                } catch (error) {
                    console.log("Rota antiga - Erro:", error.message);
                }
                
                console.log("========================================");
            }
        }

        // Executar teste de rotas
        testarRotasFamiliarCuidador();

        // Executar verifica√ß√£o do localStorage
        verificarLocalStorage();

        // Tornar a fun√ß√£o global para o onerror
        window.handleImageError = handleImageError;
    </script>

</body>

</html>