// LandingPage.js - VERS√ÉO CORRIGIDA E FUNCIONAL

document.addEventListener("DOMContentLoaded", function () {
    // Inicializar feather icons se dispon√≠vel
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Configurar menu mobile
    setupMobileMenu();

    // Configurar toggle de senha
    setupPasswordToggle();

    // Configurar formul√°rio de login
    setupLoginForm();

    // Configurar navega√ß√£o suave
    setupSmoothScrolling();

    // Configurar thumbnails da plataforma web
    setupWebThumbnails();
});

// ====================== Menu Mobile ====================== //
function setupMobileMenu() {
    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector(".nav-menu");

    if (hamburger && navMenu) {
        hamburger.addEventListener("click", () => {
            hamburger.classList.toggle("active");
            navMenu.classList.toggle("active");
        });

        document.querySelectorAll(".nav-link").forEach(n => n.addEventListener("click", () => {
            hamburger.classList.remove("active");
            navMenu.classList.remove("active");
        }));
    }
}

// ====================== Toggle de Senha ====================== //
function setupPasswordToggle() {
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');

    if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            const icon = this.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        });
    }
}

// ====================== Formul√°rio de Login ====================== //
function setupLoginForm() {
    const loginForm = document.getElementById('loginForm');
    const loginMensagem = document.getElementById('loginMensagem');

    if (loginForm) {
        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showLoginMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }

            // Valida√ß√£o b√°sica de email
            if (!validateEmail(email)) {
                showLoginMessage('Por favor, insira um e-mail v√°lido.', 'error');
                return;
            }

            // Mostrar estado de carregamento
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            submitBtn.disabled = true;

            try {
                console.log('üì§ Enviando requisi√ß√£o de login para:', email);

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        senha: password
                    })
                });

                console.log('üì• Resposta recebida, status:', response.status);

                // Verificar se a resposta √© JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('‚ùå Servidor retornou n√£o-JSON:', textResponse.substring(0, 200));
                    throw new Error('Resposta inv√°lida do servidor');
                }

                const data = await response.json();
                console.log('üìä Dados da resposta:', data);

                // No setupLoginForm, ap√≥s o login bem-sucedido:
                if (response.ok) {
                    showLoginMessage('Login realizado com sucesso! Redirecionando...', 'success');

                    // ‚úÖ Salvar dados do usu√°rio
                    console.log('‚úÖ Dados recebidos do login:', data);

                    localStorage.setItem('usuarioId', data.id);
                    localStorage.setItem('usuarioNome', data.nome);
                    localStorage.setItem('usuarioTipo', data.tipo);
                    localStorage.setItem('usuarioLogado', JSON.stringify(data));

                    console.log('‚úÖ Redirecionando para:', data.redirect);

                    // Redirecionar ap√≥s um breve delay
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1500);
                } else {
                    showLoginMessage(data.error || 'Erro ao fazer login', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro no login:', error);

                // Tratamento espec√≠fico de erros
                if (error.message.includes('Failed to fetch')) {
                    showLoginMessage('Erro: N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o.', 'error');
                } else if (error.message.includes('Unexpected token') || error.message.includes('Resposta inv√°lida')) {
                    showLoginMessage('Erro: Servidor retornou resposta inv√°lida. Contate o administrador.', 'error');
                } else {
                    showLoginMessage('Erro ao conectar com o servidor. Tente novamente.', 'error');
                }
            } finally {
                // Restaurar bot√£o
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }
}

// Fun√ß√£o auxiliar para valida√ß√£o de email
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

// Fun√ß√£o auxiliar para redirecionamento
function redirectByUserType(userType) {
    const routes = {
        'familiar_contratante': '/dependentes',
        'familiar_cuidador': '/dependentes',
        'cuidador_profissional': '/dashboard_cuidador',
        'admin': '/adm'
    };

    window.location.href = routes[userType] || '/dashboard';
}

// ====================== Mensagens de Login ====================== //
function showLoginMessage(message, type) {
    const loginMensagem = document.getElementById('loginMensagem');
    if (loginMensagem) {
        loginMensagem.textContent = message;
        loginMensagem.className = `login-mensagem ${type}`;
        loginMensagem.style.display = 'block';

        // Esconder mensagem ap√≥s 5 segundos
        setTimeout(() => {
            loginMensagem.style.display = 'none';
        }, 5000);
    }
}

// ====================== Navega√ß√£o Suave ====================== //
function setupSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}

// ====================== Thumbnails da Plataforma Web ====================== //
function setupWebThumbnails() {
    const thumbnails = document.querySelectorAll('.web-thumbnail');
    const mainImage = document.querySelector('.browser-mockup.large img');

    if (thumbnails.length > 0 && mainImage) {
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function () {
                // Remover classe active de todos os thumbnails
                thumbnails.forEach(t => t.classList.remove('active'));

                // Adicionar classe active ao thumbnail clicado
                this.classList.add('active');

                // Trocar imagem principal
                const newSrc = this.querySelector('img').getAttribute('data-full');
                if (newSrc) {
                    mainImage.src = newSrc;
                }
            });
        });
    }
}

// ====================== Anima√ß√µes de Scroll ====================== //
function setupScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);

    // Observar elementos que devem ser animados
    document.querySelectorAll('.feature-card, .app-feature, .web-feature').forEach(el => {
        observer.observe(el);
    });
}

// Inicializar anima√ß√µes de scroll quando a p√°gina carregar
window.addEventListener('load', setupScrollAnimations);